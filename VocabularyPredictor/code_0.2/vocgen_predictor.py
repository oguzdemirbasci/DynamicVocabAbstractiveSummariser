import torch
import torch.nn as nn
import torch.optim as optim
import torch.nn.functional as F
from torch.autograd import Variable

import random

from data import Data
from data import Corpus
from model import VocGenerator

vocGenFile = './params/film/outputs_bow/exp12/vocgen.bin'
K = 100
vocGenHiddenDim = 256
out_features = 12772
voc_features = 226658

seed = 1
gpuId = 0

torch.set_num_threads(1)
torch.manual_seed(seed)
random.seed(seed)
torch.cuda.set_device(gpuId)
torch.cuda.manual_seed(seed)

device = torch.device('cuda:'+str(gpuId))
cpu = torch.device('cpu')

vocGen = VocGenerator(vocGenHiddenDim, out_features, voc_features)
vocGen.load_state_dict(torch.load(vocGenFile))
vocGen.cuda()
vocGen.eval()


sourceTrainFile = '../../WikiCatSum/film_tok_min5_L7.5k/train.bow.src'
sourceOrigTrainFile = sourceTrainFile
targetTrainFile = '../../WikiCatSum/film_tok_min5_L7.5k/train.bow.tgt' 
sourceTestFile = '../../WikiCatSum/film_tok_min5_L7.5k/test.bow.src'
sourceOrigTestFile = sourceTestFile
targetTestFile = '../../WikiCatSum/film_tok_min5_L7.5k/test.bow.tgt'
minFreqSource = 2
minFreqTarget = 2
maxLen = 10000
trainPickle = 'trainData.pt' 
devPickle = 'devData.pt'


corpus = Corpus(sourceTrainFile = sourceTrainFile, sourceOrigTrainFile = sourceOrigTrainFile, targetTrainFile = targetTrainFile,
                sourceDevFile = sourceDevFile, sourceOrigDevFile = sourceOrigDevFile, targetDevFile = targetDevFile,
                minFreqSource = minFreqSource, minFreqTarget = minFreqTarget, maxTokenLen = maxLen,
                trainPickle = trainPickle, devPickle = devPickle)



test_sent_src = "practice driving have what call distribution theme brilliant fool distribution have property profit be mix loss overtake inside be activity distribution  <EOP>  comment page distribution remind story get confuse tail distribution apply height  <EOP>  rule apply distribution would have make assumption  <EOP>  can identify problem be solve investment strategy have characteristic distribution author fool distribution have probability gain probability loss period  <EOP>  realization distribution be way model datum  <EOP>  root moment density distribution function will keep be  <EOP>  argue market follow distribution distribution distribution problem course be distribution be do have variance can calculate property location scale do obey limit theorem practice can be work  <EOP>  economist analyst say distribution be simplification simplification have problem  <EOP>  realization who understand distribution have know be probability distribution  <EOP>  individual can be human wealth follow scale distribution  <EOP>  issue be distribution display characteristic market activity be devise characteristic mind  <EOP>  have time column describe distribution profit intersperse loss taleb distribution be basis trade exploit interest rate differential type arbitrage distribution be exploit trader hedge fund trading desk  <EOP>  be abstruse example drink be have distribution do smoking smoker do get lung cancer  <EOP>  distribution be miss piece investment portfolio seek protection tail risk event combine return  <EOP>  be fact modeler have be use distribution decade be be example assume return fall distribution  <EOP>  what write think should reread reply scrutiny read  <EOP>  be business lesson be draw habit driver need beware activity outcome have distribution gain punctuate loss  <EOP>  realization who understand distribution have know be probability distribution  <EOP>  go add government yesterday today appear create response be premise tailgate distribution  <EOP>  people check datum conform distribution people apply deviation datum distribution result number be extent crowd summary  <EOP>  word be use distribution workhorse consider distribution be  <EOP>  name distribution capture difficulty find strategy characteristic value provide asset allocator  <EOP>  truth be time do know probability distribution world be casino game error call can do be guess  <EOP>  have point people interpret deviation sigma like give conversion sigma distribution  <EOP>  be deliver return distribution use replication asset class return have be engineer time allocation investment instrument strategy distribution return may provide benefit diversification protection market performance shock  <EOP>  method be take blame crisis assume distribution one be tail  <EOP>  method will take blame crisis error estimate distribution quantify uncertainty  <EOP>  takedown blowhard part disagree call  <EOP>  do read know be target quant  <EOP>  test be data drive make assumption underlie distribution can give confidence interval detect significance  <EOP>  can escape problem understand risk be prelude manage know tailgate driver be be yield bond trader exploit distribution look trading strategy security market offer loss gain  <EOP>  describe be thing distribution return produce profit punctuate loss proportion trading business strategy market have tailgating call distribution author fool book read give instance  <EOP>  topic be swan event be something distribution idea deviation do model distribution event should happen lifetime universe assume variation inline process be heart model calculate risk volatility  <EOP>  think progress century will be sum realization distribution be way model datum  <EOP>  distribution build will resemble reality return will create model be example  <EOP>  will mention do need distribution make idea deviation fact be geometry probability fact variable have deviation point direction cause distribution be result distribution limit theorem  <EOP>  think bub should go have acupuncture do harmonize narcissism sufferin’  <EOP>  do have book reading list discussion put waste time side distribution  <EOP>  hear be time sound  <EOP>  fact resort attack straw man argument say everything  <EOP>  be post find argument thinking be track imagine disappointment discover post be ad hominem review man measure analysis idea  <EOP>  have lot month month be detect ratio assume symmetry distribution return  <EOP>  what be idea swan be investor be stock return do follow distribution end outcome be  <EOP>  distribution know rule state effect come cause example business client will generate income client will generate customer service request argue be move distribution shift have implication economy society  <EOP>  page write use distribution be dealing point make claim structure reality scientist do have would understood develop square distribution context curve observation do lot math be do science  <EOP>  have provide comment be thing be miss  <EOP>  thank somebody see be bag bat  <EOP>  people ask people get heckle be be lack phrase fan boy thing exist people have prophet  <EOP>  distribution be have experience upside distribution lead crisis insurance market loss policy insure syndicate loss magnitude underwriter point have take premium year pay nothing do have be see flaw do have be syndicate  <EOP>  writing make assumption can fill miss step will find provide argument get point  <EOP>  thank do think be omit fact  <EOP>  allude paper be form manuscript be throw argument talk trash practitioner statistic  <EOP>  trader business people be upside distribution be accident wait happen puzzle year organisation believe be make money trading security market business be trade be motion do money fuel system come distribution  <EOP>  what fail mention be understand deviation have distribution interpretation can be example data be distribute be probability datum observation will be sigma  <EOP>  expert expert something joke  <EOP>  be what expect read deviation be average deviation can characterize distribution deviation be summary get reality be thing distribution distribution be define number line infinity infinity reality provide bound be distort instance distribution averaging deviation bound be way be be go have do something replace miss probability  <EOP>  article use adore be enter world finance trading tend repeat do do  <EOP>  point be uncertainty can be parameteriz distribution fool translate uncertainty risk characterize distribution point hill point rest swan expound bias comform parameteriz risk have cell number number must mean something  <EOP>  distribution be do appear nature be behave have be study amount progress be go come wrestle distribution pay attention assumption normality need be question challenge be distribution be bake number exist tool  <EOP>  argument know put book read have hear method datum analysis visualization tool estimation  <EOP>  nail sentiment engender read book have listen seem get tail distribution know thank do convince be quant self critique make sense posturing  <EOP>  keep buy money guy market come crash  <EOP>  would be think contribution discourse be do agree  <EOP>  reiterate be nothing distribution be retire addition subtraction be people who do realize be math  <EOP>  could sketch statement could be make intuition be expect proportion observation should be parameter distribution  <EOP>  deviation assumption normality be limit theorem have iid variable have finite deviation sum will converge distribution number variable increase  <EOP>  argument be way suggest would be market  <EOP>  understand paper be fight agree  <EOP>  year run hedge fund universa tenure generate digit return become duo shut fund have give money management teach risk management write book advise government theory  <EOP>  disagree comparison would write thing make sense seem be makin’ raspberri school disputation throw repent sin  <EOP>  antic be what sell nobody care criticism model make be criticize quant model know name state term do work point alternative would be fan hell event would be sahabah companion prophet go television blurt nobody know nothing argument head be fist  <EOP>  like lot people attack be make mistake describe book  <EOP>  have hear email  <EOP>  quality decision can be judge base outcome  <EOP>  datum be draw distribution form deviation be deviation form be exp(-x^2 deviation be use deviation depend distribution datum be field call statistic look question  <EOP>  taleb book introduce seneca stoicism area bias have spend time consider think reading book cover area stoicism read seneca letter marcus aurelius meditation be read taleb version bias read kahneman be read taleb sound area agree taleb finance math think person would gain understanding  <EOP>  limit theorem show datum lot source error tend distribution description be pass model lot lot context deviation speak distribute datum  <EOP>  have question defender would love know have offer follow idea  <EOP>  adviser sit interview evening assessment risk say be risk war  <EOP>  distribution have mean justify instrument role asset allocation framework fat tail be co locate tail instrument add protection investment portfolio tail risk event  <EOP>  think smear may be confuse  <EOP>  article be base paper publish want test submit experiment page  <EOP>  point number memo be future should be view fix outcome destine happen be predict range possibility basis insight likelihood probability distribution  <EOP>  do have problem comment interest pay attention what have say  <EOP>  taleb philosopher observe come preservation perpetuation life advice be shalt not  <EOP>  post be reply someone ask assume be talk reference  <EOP>  fool  <EOP>  be matter trust have point direction literature regard revival shot lure want know what expert think can read  <EOP>  would offer alternative say be alternative throw  <EOP> have state crisis be swan do claim be predict  <EOP>  be do see value deviation deviation be  <EOP>  think method be solution deal datum what be propose  <EOP>  problem course be distribution be do have variance can calculate property location scale do obey limit theorem practice can be work  <EOP>  difference type risk be structure impact structure be scale scale example scale distribution be weight adult human be time weight human  <EOP>  allude paper be form manuscript be throw argument talk trash practitioner statistic report finding experiment group statistician will quote  <EOP>  solution problem hedge tail risk event be have strategy performance pattern help reduce impact market performance shock instrument return distribution feature mean fat tail be realize portfolio take hit  <EOP>  book find way fill publisher ink cartridg crap have manuscript send printer  <EOP>  piece fiction be unknown be know  <EOP>  be snark post be call prophet who be thing criticize fool  <EOP>  way study stock rate see argument thing would do see blog  <EOP>  tag swan delta hedging volatility nickel front steamroller option vix volatility volatility arbitrage  <EOP>  do think criticism be be hysteria may be marketing tactic read argument affirm nihilism be read argument say be writing clinic  <EOP>  be base statement hahahaah enlight source know be lie profession  <EOP>  be see anybody who think deviation be deviation be assertion insult group people be craft  <EOP>  play comparison editor would play have share cover issue  <EOP>  clown finance science be set sort alpha monkey quant state misleading head alpha monkey  <EOP>  hold book be be book talk adn idea book need  <EOP>  have time write article make money prove people wrong  <EOP>  do claim banking crash be swan be have say overlook  <EOP>  be have time decide be could tell worth can compare  <EOP>  will say reader be word player can help pick word  <EOP>  be wonder have lot invest concept technique be suggest be break be tone defensiveness post  <EOP>  rely prediction event be fault predict predict mean do understand what be talk  <EOP>  be say be world thing people be what write be view what write be  <EOP>  hero be master bank who keep sanity time be do fine thank restraint maturity point be identify flaw quant model keep regulation do job decade  <EOP>  think be taleb phenomenon post crisis example everything criticise crisis one wonder anyone audience lecture reflect contradiction event fact predict fact explain be sell insight declare predict event explain  <EOP>  see taleb post pick hole what say someone who be taleb book have change outlook aspect life have try find hole logic have be be convince post change get think taleb post do resort play man idea  <EOP>  be base be everything year finance do make model model base know process be hell concept distribution be lie everyone know process be  <EOP>  pop writer finance present be screed be what spur write post article be write guess guy be fund partner be surprise suffer mush absurdity article book will pick guy mention name get job do have manner make figure hand be finance be read writer seem earn bread show be be mean be nihilist feyerabend think could know anything reason get think finance be nonsense should do quant be guess delusion have something do drink tapwater make everyone believe thing be trader prejudice trader dislike quant cut  <EOP>  want make argument need look writing logic be relativist  <EOP>  problem be refer model be publish model model be use concept found physics  <EOP>  do agree idiot statement concur thought hope do let affect senescence  <EOP>  appeal mountebank be sum be bear minute have be writer may have educate reader concept sample bias be writer nobody would read stuff be lot understand  <EOP>  guess share problem model read would say map be territory regard software abstraction think space model reality be find lot thing include ability make lot money  <EOP>  regard comment should be require expect reader read book read op ed piece  <EOP>  be have influence scientist history second  <EOP>  copyright tastytrade reserve portion term use apply reproduction adaptation distribution display exhibition profit storage storage medium whole part be prohibit penalty law provide may download tastytrade podcast view use  <EOP>  month have be form thesis world be head thinking come book author who have influence thinking be idea follow be idea intersect get hypothesis  <EOP>  think finance be nonsense should do quant be guess delusion have something do drink tapwater make everyone believe thing be trader prejudice trader dislike quant cut  <EOP>  could make story fill blank be monkey say be could make story fill blank be crisis could concentrate what say book essay article  <EOP>  non normality be have make expert regression have listen would have throw hand go physics  <EOP>  be live fund have point trade inverse swan strategy ratio  <EOP>  can be peer review internet do get pay make fun living sound fun job  <EOP>  try get writing strike self involve make finish  <EOP>  love book work datum scientist statistic  <EOP>  be begin publish argument year continue publish be read paper read book follow order  <EOP>  be quant outfit work option thing what be be overtone one business be moron do think believe market move be distribute write paper distribution tail area move seem think can be model have understand reason think be area statistic value theory seem apply datum datum yield model have reason think have break market crash  <EOP>  world have lose trillion world have make lose trillion paper gain loss hand risk manager courtesy model base distribution technique use technique look underestimate risk lead paper profit cash bonus require reserve  <EOP>  have consider exercise can deduce what distribution be describe situation have gain have risk reward profile can transfer idea trade purpose calculation will assume trip cost trading equate pip commission course will vary market liquidity strategy be employ hedge fund be refer pick penny steamroller  <EOP>  criticize argument year argue do take account nature war phenomenon time series event characterize tail process have period quiescence get rip upheaval lure mind interpretation respond clarify view quote come response acknowledge possibility view suggest have evidence be  <EOP>  be metric treat be encounter treat science course would be serve stop teach favor emphasis distribution distribution be touch curricula overfavor distribution end student  <EOP>  have nothing do everything do inquiry academic be thinker follower would be prevent abuse paradigms  <EOP>  author fool trader illustrate concept risk hedge strategy loss  <EOP>  assume experience be draw bell shape distribution claim be base be write percentage probability would encounter deviation event follow deviation event line column would be occupy zero thing do occur what do  <EOP>  people have bias look return look loss say reduce loss return will be  <EOP>  be relativist be positivist be what economic faculty be be falsificationist experience research methodologist be falsificationist  <EOP>  agree duck be water be generall do make rest what say go read what write  <EOP>  have think polemic be go be direct guy sample mountebank  <EOP>  remain name model suggest alternative state model do work be boat sink state do work fix be be anything rate charlatan who impress rube word  <EOP>  challenge strategy be have make choice payoff occur environment can know control step embrace uncertainty be try characterize what variety face activity company work year have emphasize level uncertainty level offer view future range outcome support decision level be number outcome company should prepare level outcome be represent set point range can be understand probability distribution level feature ambiguity distribution outcome be  <EOP>  trader bestselling author do something do wear tie have express distaste blood constrain artifact who tend don let world know be day betray disposition  <EOP>  dismiss post will get quant debate be judge will pick  <EOP>  be fan have swan become revile expert book warn hostility case seem place  <EOP>  description author fool trader illustrate concept risk hedge strategy loss  <EOP>  be scratch head confusion do worry will continue delve topic example picture can grasp basic idea strategy be option trade volatility be realize volatility academic believe option trade imply volatility assume bell shape distribution stock return can agree stock return be anything go volatility fact quarter have move excess trading day assume have term deviation move be excess deviation nutshell equity market be fat tail mean observation be mean happen distribution can account would argue event wipe profit sell option  <EOP>  example come disdain mathematic economic have misstate case minority economic finance marketing faculty believe economic have become nothing calculus disdain come philosophy be type theory theory have be disprove physics theory can be disprove give research method  <EOP>  be ratio do noticing fund be pile suck feel pick performance metric return return ratio bias ratio do matter fund amount whera bet strat be business tail risk can be manage  <EOP>  do point situation work point work do address problem substitution create  <EOP>  state deviation tell measurement be show market be have tail give datum support argument  <EOP>  do agree part analysis think miss point event be definition can do be hedge event say shall be option be matter cap loss provide payoff may be sell option may make money short imply volatility be hedge be say be do make sense point be target be  <EOP>  year go be know distribution war size follow power law number event size be raise exponent be approximation course be size conflict can be population power law form can hold range take account rescale datum take account size population"

test_sent_tgt = "economic finance distribution be profile investment provide payoff return carry risk loss <SNT> term be coin journalist economist describe investment probability gain probability loss period <SNT> concept be name base idea outline fool <SNT> accord term should be call payoff reflect importance payoff function probability distribution distribution <SNT> term be mean refer investment return profile be probability gain probability loss outweighs gain <SNT> situation expect value be fact be camouflage appearance risk return <SNT> be combination kurtosis risk risk return be dominate event kurtosis be downside skew <SNT> discussion bet probability event be essay call do happen write agent risk people capital would have incentive camouflage property show income <SNT> hedge fund be pay basis disaster happen year example <SNT> fund manager do repay incentive fee "

tokensSource = test_sent_src.split()
tokensTarget = test_sent_tgt.split()

tokenIndicesSource = torch.LongTensor(len(tokensSource))
unkMapSource = {}
tokenIndicesTarget = torch.LongTensor(len(tokensTarget))
unkMapTarget = {}

for i in range(len(tokensSource)):
    t = tokensSource[i]
    tokenIndicesSource[i] = corpus.sourceVoc.getTokenIndex(t)
    if tokenIndicesSource[i] == corpus.sourceVoc.unkIndex:
        unkMapSource[i] = t

for i in range(len(tokensTarget)):
    t = tokensTarget[i]
    tokenIndicesTarget[i] = corpus.targetVoc.getTokenIndex(t)
    if tokenIndicesTarget[i] == corpus.targetVoc.unkIndex:
        unkMapTarget[i] = t

data = [Data(tokenIndicesSource, unkMapSource, tokenIndicesTarget, unkMapTarget, tokensSource)]

targetVocGen, inputVocGen = corpus.processBatchInfoVocGen(data, train = False, smoothing = False, volatile = True, device = device)

outputVocGen = vocGen(inputVocGen)



tmp = F.sigmoid(outputVocGen.data).data #+ targetVocGen.data
tmp[:, corpus.targetVoc.unkIndex] = 1.0
val, output_list = torch.topk(tmp, k = K)
output_list = output_list.cpu()

tokens = corpus.targetVoc.tokenList

print([tokens[x].str for x in output_list.numpy()[0]])